// Generated by CoffeeScript 1.3.3
(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}};e=function(){function e(){this.colorize=t(this.colorize,this),this.numberFormat=t(this.numberFormat,this),this.updatePageComponents=t(this.updatePageComponents,this),this.getInfoHtml=t(this.getInfoHtml,this),this.loadDataFromState=t(this.loadDataFromState,this),this.setIntercoDepartementSelection=t(this.setIntercoDepartementSelection,this),this.setOptionSelection=t(this.setOptionSelection,this),this.loadIntercoOptionList=t(this.loadIntercoOptionList,this),this.loadIntercoDepartementOptionList=t(this.loadIntercoDepartementOptionList,this),this.loadDepartementRegionOptionList=t(this.loadDepartementRegionOptionList,this),this.generateUrl=t(this.generateUrl,this),this.generateTitle=t(this.generateTitle,this),this.generateNewHistoryState=t(this.generateNewHistoryState,this),this.extractStateFromUrl=t(this.extractStateFromUrl,this),this.getCurrentState=t(this.getCurrentState,this);var e;this.appSettings={applicationRootUrl:window.appUrl||window.location.protocol+"//"+window.location.hostname,numberFormat:"# ##0."},this.history=window.History,this.rollbackUrl=window.location.href,this.currentState=this.getCurrentState(),this.initEvents(),this.updatePageComponents(),this.currentState.level!=="intercos"?(this.loadDepartementRegionOptionList(),this.loadDataFromState()):(this.loadDataFromState(),this.loadIntercoDepartementOptionList()),this.colors={give:"#DD003F",neutral:"#F7C63C",receive:"#86BC31"},e=this}return e.prototype.initEvents=function(){var e,t=this;return e=this,$(document).ajaxError(function(e,t,n,r){$("body").removeClass("busy");if(t.status===403)return $("#unautorized").modal("show")}),$(document).ajaxStart(function(){return $("body").addClass("busy")}),$(document).ajaxStop(function(){return $("body").removeClass("busy")}),$(document).on("click",".niveau a",function(t){var n;return t.preventDefault(),n=$(this).data("level"),$(".level").attr("class","level "+n),e.generateNewHistoryState({level:n,collectivite1:null,collectivite2:null,collectivite3:null,change:"level"})}),$(document).on("change",".choose",function(t){var n,r,i;return r=e.getCurrentState(),n=$(this).data("collectivite"),i={},i["collectivite"+n]=$(this).val(),r.level==="intercos"&&(i["departement"+n]=$(".collectivite"+n+" .interco_departements option:selected").val()),i.change="collectivite",e.generateNewHistoryState(i)}),$(document).on("change",".interco_departements",function(t){var n,r;return r=$(this).val(),n=$(this).data("collectivite"),$(".collectivite.collectivite"+n+" .infos").empty(),$(".collectivite.collectivite"+n+" .infos").removeClass("show"),$(".collectivite.collectivite"+n+" .choose").empty(),e.loadIntercoOptionList(r,n)}),$("#unautorized .rollback").on("click",function(e){return ga("send","event","subscription","no"),t.generateNewHistoryState(null,!0)}),$("#unautorized .identify").on("click",function(e){var n;return n=window.location.href,$(t).hasClass("register")?(ga("send","event","subscription","yes"),ga("send","event","subscription-from",n)):ga("send","event","subscription","identify"),window.location.href=encodeURI(""+t.appSettings.applicationRootUrl+"/identifier?url="+n)}),History.Adapter.bind(window,"statechange",function(){var t;return t=e.getCurrentState(),t.change==="level"?($(".collectivite .infos").empty(),$(".collectivite .choose").empty(),$(".collectivite .interco_departements option:selected").prop("selected",!1),t.level!=="intercos"?e.loadDepartementRegionOptionList():e.loadIntercoDepartementOptionList()):t.change==="collectivite"&&e.loadDataFromState(),e.updatePageComponents()})},e.prototype.getCurrentState=function(){var e;return this.currentState?this.currentState:(e=this.extractStateFromUrl(window.location.href),e?this.currentState=e:!1)},e.prototype.extractStateFromUrl=function(e){var t,n,r,i,s;return n=new RegExp("^"+this.appSettings.applicationRootUrl+"/comparer/intercos/?(?:([0-9A-B]{1,2})-([0-9]*))?/?(?:([0-9A-B]{1,2})-([0-9]*))?/?(?:([0-9A-B]{1,2})-([0-9]*))?$"),s=new RegExp("^"+this.appSettings.applicationRootUrl+"/comparer/(regions|departements)/?([0-9A-B]*)?/?([0-9A-B]*)?/?([0-9A-B]*)?$"),(r=n.exec(e))?(t={level:"intercos",departement1:r[1],collectivite1:r[2],departement2:r[3],collectivite2:r[4],departement3:r[5],collectivite3:r[6]},t):(i=s.exec(e))?(t={level:i[1],collectivite1:i[2],collectivite2:i[3],collectivite3:i[4]},t):null},e.prototype.generateNewHistoryState=function(e,t){var n,r,i;return t==null&&(t=!1),t?window.location.href=this.rollbackUrl:(this.rollbackUrl=window.location.href,_.extend(this.currentState,e)),r=this.generateTitle(this.currentState),i=this.generateUrl(this.currentState),n=i.replace(this.appSettings.applicationRootUrl,""),ga("send","pageview",{page:n,title:r}),History.pushState(this.currentState,r,i)},e.prototype.generateTitle=function(e){var t;t="A qui profitent les péréquations : Comparer les ";switch(this.currentState.level){case"regions":t+=" régions";break;case"departements":t+=" départements";break;case"intercos":t+=" intercommunalités"}return this.currentState.collectivite1&&(t+=" "+this.currentState.collectivite1),this.currentState.collectivite2&&(t+=" - "+this.currentState.collectivite2),this.currentState.collectivite3&&(t+=" - "+this.currentState.collectivite3),t},e.prototype.generateUrl=function(e){var t;return t=this.appSettings.applicationRootUrl+"/comparer/"+e.level,this.currentState.level!=="intercos"?(this.currentState.collectivite1&&(t+="/"+this.currentState.collectivite1),this.currentState.collectivite2&&(t+="/"+this.currentState.collectivite2),this.currentState.collectivite3&&(t+="/"+this.currentState.collectivite3)):(this.currentState.collectivite1&&(t+="/"+this.currentState.departement1+"-"+this.currentState.collectivite1),this.currentState.collectivite2&&(t+="/"+this.currentState.departement2+"-"+this.currentState.collectivite2),this.currentState.collectivite3&&(t+="/"+this.currentState.departement3+"-"+this.currentState.collectivite3)),t},e.prototype.loadDepartementRegionOptionList=function(){var e,t,n=this;return e=this.getCurrentState(),t=this,$.ajax({url:this.appSettings.applicationRootUrl+"/api/liste/"+e.level,dataType:"json",success:function(n){var r;return e.level==="regions"?r="<option value=''>Choisir une région</option>":e.level==="departements"&&(r="<option value=''>Choisir un département</option>"),_.each(n,function(e){return r+="<option value='"+e.id+"'>"+e.nom.toUpperCase()+"</option>"}),$(".collectivite .choose").html(r),t.setOptionSelection(e)}})},e.prototype.loadIntercoDepartementOptionList=function(){var e,t,n=this;return e=this.getCurrentState(),t=this,$.ajax({url:this.appSettings.applicationRootUrl+"/api/liste/departements",dataType:"json",success:function(n){var r;return r="<option value=''>Choisir un département</option>",_.each(n,function(e){return r+="<option value='"+e.id+"'>"+e.nom.toUpperCase()+"</option>"}),$(".collectivite .interco_departements").html(r),_.each(["1","2","3"],function(n){if(e["departement"+n])return t.setIntercoDepartementSelection(e["departement"+n],n),t.loadIntercoOptionList(e["departement"+n],n)})}})},e.prototype.loadIntercoOptionList=function(e,t){var n,r,i=this;return n=this.getCurrentState(),r=this,$.ajax({url:this.appSettings.applicationRootUrl+("/api/liste/intercos?departement_id="+e),dataType:"json",success:function(e){var i;return i="<option value=''>Choisir une intercommunalité</option>",_.each(e,function(e){return i+="<option value='"+e.id+"'>"+e.nom.toUpperCase()+"</option>"}),$(".collectivite.collectivite"+t+" .choose").html(i),r.setOptionSelection(n)}})},e.prototype.setOptionSelection=function(e){return _.each(["collectivite1","collectivite2","collectivite3"],function(t){if(e[t])return _.each($("."+t+" .choose option"),function(n){if($(n).val()===e[t])return $(n).prop("selected",!0)})})},e.prototype.setIntercoDepartementSelection=function(e,t){return _.each($(".collectivite"+t+" .interco_departements option"),function(t){if($(t).val()===e)return $(t).prop("selected",!0)})},e.prototype.loadDataFromState=function(e){var t,n,r,i=this;return r=this,t=this.getCurrentState(),n=[],_.each(["collectivite1","collectivite2","collectivite3"],function(e){var r;r=$("."+e+" .infos");if(t[e])if(r.data("level")!==t.level||r.data("id")!==t[e])return n.push(t[e])}),$.ajax({url:this.appSettings.applicationRootUrl+"/api/comparer/"+t.level,data:{id:n},dataType:"json",success:function(n){return _.each(["collectivite1","collectivite2","collectivite3"],function(i){var s,o;s=t[i];if(s&&s.length>0&&s in n){o=$("."+i+" .infos"),o.html(r.getInfoHtml(n[s],t.level)),o.data("level",t.level),o.data("id",s),o.addClass("show");if(e)return e()}})}})},e.prototype.getInfoHtml=function(e,t){var n;return n='<div class="title">'+e.nom+"</div>            <ul>                <li class='header'>Population</li>",e.population?n+="<li>"+format(this.appSettings.numberFormat,e.population)+" habitants</li>":n+="<li>Données non disponibles</li>",n+="<li class='header'>Revenu par habitant</li>                <li>"+format(this.appSettings.numberFormat,e.revenu_hab)+" &euro; / Rang : "+e.revenu_hab_rang+"</li>                <li>Moyenne nationale : "+format(this.appSettings.numberFormat,e.revenu_hab_moyen)+" &euro;</li>                <li class='header'>Perequations</li>            ",e.total_hab_rang_2012?n+="<li class='section'><b>Total par habitant : "+this.numberFormat(e.total_hab_2012)+" &euro; / Rang : "+e.total_hab_rang_2012+"</b></li>":n+="<li class='section'><b>Total par habitant : "+this.numberFormat(e.total_hab_2012)+" &euro; / Rang : non applicable</b></li>",e.total_rang_2012?n+="<li>Total : "+this.numberFormat(e.total_2012)+" &euro; / "+this.colorize("Rang : "+e.total_rang_2012,e.total_2012)+"</li>":n+="<li>Total : "+this.numberFormat(e.total_2012)+" &euro; / Rang : non applicable</li>",e.fpic_hab_rang_2012?n+="<li class='section'><b>FPIC par habitant : "+this.numberFormat(e.fpic_hab_2012)+" &euro; / Rang : "+e.fpic_hab_rang_2012+"</b></li>":n+="<li class='section'><b>FPIC par habitant : "+this.numberFormat(e.fpic_hab_2012)+" &euro; / Rang : non applicable</b></li>",e.fpic_rang_2012?n+="<li>FPIC : "+this.numberFormat(e.fpic_2012)+" &euro; / "+this.colorize("Rang : "+e.fpic_rang_2012,e.fpic_2012)+"</li>":n+="<li>FPIC : "+this.numberFormat(e.fpic_2012)+" &euro; / Rang : non applicable</li>",t!=="intercos"&&(e.dmto_hab_rang_2012?n+="<li class='section'><b>DMTO par habitant : "+this.numberFormat(e.dmto_hab_2012)+" &euro; / Rang : "+e.dmto_hab_rang_2012+"</b></li>":n+="<li class='section'><b>DMTO par habitant : "+this.numberFormat(e.dmto_hab_2012)+" &euro; / Rang : non applicable</b></li>",e.dmto_rang_2012?n+="<li>DMTO : "+this.numberFormat(e.dmto_2012)+" &euro; / "+this.colorize("Rang : "+e.dmto_rang_2012,e.dmto_2012)+"</li>":n+="<li>DMTO : "+this.numberFormat(e.dmto_2012)+" &euro; / Rang : non applicable</li>"),t!=="regions"&&(n+="<li class='header'>Potentiel fiscal par habitant</li>                        <li>"+this.numberFormat(e.potentiel_fiscal_hab)+" &euro; / Rang : "+(e.potentiel_fiscal_rang||e.potentiel_fiscal_hab_rang)+"</li>                        <li>Moyenne nationale : "+this.numberFormat(e.potentiel_fiscal_moyen||e.potentiel_fiscal_hab_moyen)+" &euro;</li>"),n+="</ul>",n},e.prototype.updatePageComponents=function(){var e;return e=this.getCurrentState(),$(".niveau a.active").hasClass(e.level)||($(".niveau a.active").removeClass("active"),$(".niveau a."+e.level).addClass("active")),_.each($(".collectivite .infos"),function(e){if($(e).is(":empty"))return $(e).removeClass("show")})},e.prototype.numberFormat=function(e){return parseInt(e)>0?"+ "+format(this.appSettings.numberFormat,e):format(this.appSettings.numberFormat,e)},e.prototype.colorize=function(e,t){var n;return t>999?n=this.colors.receive:t<-999?n=this.colors.give:n=this.colors.neutral,"<b style='color: "+n+";'>"+e+"</b>"},e}(),$(function(){if($("#comparer").length>0)return new e})}).call(this);